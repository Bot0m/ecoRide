{% extends 'base.html.twig' %}

{% block title %}Ecoride - Accueil{% endblock %}

{% block body %}

<!-- Hero -->
<section class="relative h-screen pt-20 bg-cover bg-center bg-no-repeat" style="background-image: url('{{ asset('images/pexels-lkloeppel-577696.jpg') }}');">

    <div class="absolute inset-0 flex flex-col items-center justify-center text-center px-4">
        <!-- Carte glassmorphique horizontale -->
        <!-- Section Trajets du jour -->
        {% if app.user and todayRides|length > 0 %}
            <div class="w-full max-w-6xl backdrop-blur-xl backdrop-saturate-150 backdrop-contrast-125 bg-white/30 rounded-2xl shadow-2xl border border-white/30 p-6 mb-6">
                <h2 class="text-xl font-title text-textPrimary mb-4 text-center">Vos trajets du jour</h2>
                <div class="grid gap-4">
                    {% for ride in todayRides %}
                        {% include 'partials/_ride_card.html.twig' with {
                            'ride': ride,
                            'userParticipations': userParticipations,
                            'showTodayActions': true
                        } %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <div class="w-full max-w-6xl backdrop-blur-xl backdrop-saturate-150 backdrop-contrast-125 bg-white/30 rounded-2xl shadow-2xl border border-white/30 p-6 mb-6">
            <form method="get" action="{{ path('app_rides') }}" class="flex flex-wrap justify-center gap-2 md:gap-4">
                <div class="relative">
                    <input
                        type="text"
                        name="departure"
                        id="home-departure"
                        placeholder="Ville de départ"
                        autocomplete="off"
                        class="px-4 py-2 font-body text-secondary rounded-lg bg-backgroundDark text-textPrimary placeholder-tSecondaryLight border-accentDark focus:border-accentDark"
                    />
                    <div id="home-departure-suggestions" class="absolute top-full left-0 right-0 bg-backgroundDark border border-accentDark rounded-lg mt-1 max-h-60 overflow-y-auto z-50 hidden shadow-xl"></div>
                </div>
                <div class="relative">
                    <input
                        type="text"
                        name="arrival"
                        id="home-arrival"
                        placeholder="Ville d'arrivée"
                        autocomplete="off"
                        class="px-4 py-2 font-body text-secondary rounded-lg bg-backgroundDark text-textPrimary placeholder-tSecondaryLight border-accentDark focus:border-accentDark"
                    />
                    <div id="home-arrival-suggestions" class="absolute top-full left-0 right-0 bg-backgroundDark border border-accentDark rounded-lg mt-1 max-h-60 overflow-y-auto z-50 hidden shadow-xl"></div>
                </div>
                
                <div class="relative max-w-sm">
                    <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
                        <svg class="w-4 h-4 text-tSecondaryLight" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M20 4a2 2 0 0 0-2-2h-2V1a1 1 0 0 0-2 0v1h-3V1a1 1 0 0 0-2 0v1H6V1a1 1 0 0 0-2 0v1H2a2 2 0 0 0-2 2v2h20V4ZM0 18a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V8H0v10Zm5-8h10a1 1 0 0 1 0 2H5a1 1 0 0 1 0-2Z"/>
                        </svg>
                    </div>
                    <input name="date" type="date" 
                        value="{{ 'now'|date('Y-m-d') }}"
                        class="font-body text-secondary bg-backgroundDark border border-accentDark text-textPrimary placeholder-tSecondaryLight text-body rounded-lg block w-full ps-10 p-2.5 focus:border-accentDark" 
                        placeholder="Date de départ">
                </div>

                <div class="relative flex items-center max-w-[8rem]">
                    <button type="button" id="home-decrement-button" data-input-counter-decrement="home-quantity-input" class="group bg-background hover:bg-backgroundDark border border-accentDark rounded-s-lg p-3 h-11">
                        <svg class="w-3 h-3 text-tSecondaryLight group-hover:text-textPrimary" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 2">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M1 1h16"/>
                        </svg>
                    </button>
                    <input type="text" id="home-quantity-input" name="passengers" data-input-counter aria-describedby="helper-text-explanation" class="font-body text-secondary bg-backgroundDark border-x-0 border-accentDark h-11 text-center text-textPrimary text-body block w-full py-2.5 focus:border-accentDark" value="1" min="1" max="4" required />
                    <button type="button" id="home-increment-button" data-input-counter-increment="home-quantity-input" class="group bg-background hover:bg-backgroundDark border border-accentDark rounded-e-lg p-3 h-11">
                        <svg class="w-3 h-3 text-tSecondaryLight group-hover:text-textPrimary" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 18">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 1v16M1 9h16"/>
                        </svg>
                    </button>
                </div>

                <button type="submit" class="font-body text-base text-textSecondary hover:text-textPrimary bg-accent hover:bg-accentDark rounded-lg text-body px-4 py-2 transition-all duration-300">
                    Rechercher
                </button>
            </form>
        </div>
        <br>
        <h1 class="text-title font-title text-secondary">
            Bienvenue sur Ecoride,
            <br>
            réduisez vos coûts, réduisez votre impact
        </h1>
    </div>
</section>

<!-- Section A propos -->
<section id="qui-sommes-nous" class="bg-backgroundDark">
    <div class="grid max-w-screen-xl px-4 py-8 mx-auto lg:gap-8 xl:gap-0 lg:py-16 lg:grid-cols-12">
        <div class="mr-auto place-self-center lg:col-span-7">
            <h1 class="max-w-2xl mb-4 text-title font-title text-textPrimary tracking-tight leading-none md:text-5xl xl:text-6xl">Qui sommes nous ?</h1>
            <p class="max-w-2xl mb-6 text-base font-body text-textSecondary lg:mb-8 md:text-lg lg:text-xl">EcoRide est une plateforme innovante dédiée à la mobilité durable. Notre mission est de proposer des solutions pratiques et accessibles pour encourager des déplacements respectueux de l'environnement. Nous croyons que chaque trajet peut contribuer à un avenir plus propre, et nous mettons tout en œuvre pour rendre l'écomobilité plus simple et efficace pour tous. 
            <br>
            Notre ambition est de révolutionner la mobilité urbaine en mettant à disposition des outils intelligents pour une gestion plus verte des déplacements. Nous voulons sensibiliser, accompagner et proposer des alternatives concrètes pour permettre à chacun de contribuer à la transition écologique, sans compromis sur la praticité et le confort.</p>
        </div>
        <div class="hidden lg:mt-0 lg:col-span-5 lg:flex">
            <img src="{{ asset('images/pexels-davidgallie-28884704.jpg') }}" alt="pexels-davidgallie-28884704" class="rounded-lg shadow-lg transform hover:scale-105 hover:rotate-1 transition-all duration-300">
        </div>                
    </div>
</section>

<!-- Section A propo 2 -->
<section class="bg-center bg-cover bg-no-repeat bg-gray-500 bg-blend-multiply" style="background-image: url('{{ asset('images/pexels-pripicart-620335.jpg') }}');">
    <div class="px-4 mx-auto max-w-screen-xl text-center py-24 lg:py-56">
        <h1 class="mb-4 text-title font-title tracking-tight leading-none text-accent md:text-5xl lg:text-6xl">Pourquoi choisir EcoRide ?</h1>
        <br>
        <p class="mb-8 text-base font-body text-accentLight lg:text-xl sm:px-16 lg:px-48">Face aux défis environnementaux actuels, EcoRide s'engage à promouvoir une alternative aux modes de transport polluants. En choisissant notre solution, vous participez à une démarche écologique visant à réduire l'empreinte carbone des déplacements quotidiens.
        <br>
        Nous privilégions des pratiques responsables et des outils innovants pour rendre chaque trajet plus durable, tout en garantissant une expérience fluide et agréable.</p>
    </div>
</section>

<!-- Section Avis des utilisateurs -->
{% if topReviews|length > 0 %}
<section class="bg-backgroundDark py-24">
    <div class="max-w-screen-xl mx-auto px-4">
        <div class="text-center mb-16">
            <h2 class="text-3xl font-title text-textPrimary mb-6">Ce que disent nos utilisateurs</h2>
            <p class="text-textSecondary font-body text-lg">Découvrez les avis de nos utilisateurs satisfaits</p>
        </div>
        
        <div class="relative">
            <!-- Container pour les avis rotatifs -->
            <div id="reviewsCarousel" class="flex transition-transform duration-1000 ease-out">
                {% for review in topReviews %}
                    <div class="review-slide w-full flex-shrink-0 px-4">
                        <div class="max-w-2xl mx-auto">
                            <div class="bg-gradient-to-br from-accent/20 to-accent/10 backdrop-blur-sm rounded-2xl p-8 border border-accent/30 shadow-xl">
                                <!-- Note avec étoiles -->
                                <div class="flex justify-center mb-8">
                                    <div class="flex items-center">
                                        {% for i in 1..5 %}
                                            <svg class="w-8 h-8 {% if i <= review.rating %}text-accentDark{% else %}text-textSecondary/30{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                            </svg>
                                        {% endfor %}
                                        <span class="ml-3 text-textPrimary font-base text-lg">{{ review.rating }}/5</span>
                                    </div>
                                </div>
                                
                                <!-- Commentaire -->
                                {% if review.comment %}
                                    <blockquote class="text-center mb-10">
                                        <p class="text-xl font-body text-textPrimary italic leading-relaxed">"{{ review.comment }}"</p>
                                    </blockquote>
                                {% else %}
                                    <div class="text-center mb-10">
                                        <p class="text-xl font-body text-textPrimary italic leading-relaxed">"Excellent trajet, je recommande !"</p>
                                    </div>
                                {% endif %}
                                
                                <!-- Espacement entre commentaire et infos -->
                                <div class="h-6"></div>
                                
                                <!-- Informations de l'auteur et du trajet -->
                                <div class="text-center">
                                    <div class="mb-4">
                                        <p class="text-textPrimary font-base text-lg font-semibold mb-2">{{ review.author.pseudo }}</p>
                                        {% if review.participation and review.participation.ride %}
                                            <p class="text-textSecondary text-sm">{{ review.participation.ride.departure }} → {{ review.participation.ride.arrival }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            
            <!-- Espacement supplémentaire -->
            <div class="h-8"></div>
            
            <!-- Indicateurs de navigation -->
            <div class="flex justify-center space-x-3">
                {% for i in 0..(topReviews|length - 1) %}
                    <button class="review-indicator w-4 h-4 rounded-full bg-accent/50 hover:bg-accent transition-colors duration-300 {% if i == 0 %}bg-accent{% endif %}" data-index="{{ i }}"></button>
                {% endfor %}
            </div>
        </div>
    </div>
</section>
{% endif %}

<!-- Modal de confirmation pour démarrer un trajet -->
<div id="startRideModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center">
    <div class="backdrop-blur-xl backdrop-saturate-150 backdrop-contrast-125 bg-white/30 rounded-2xl shadow-2xl border border-white/30 p-8 max-w-md mx-4 transform transition-all">
        <div class="text-center">
            <h3 class="text-subtitle font-title text-backgroundDark mb-2">Démarrer le trajet</h3>
            <p class="text-background mb-6" id="startRideText">
                Êtes-vous sûr de vouloir démarrer ce trajet ?
            </p>
            <div class="flex gap-4 justify-end">
                <button id="confirmStartRideBtn" class="bg-accent hover:bg-accentDark backdrop-blur-sm hover:backdrop-blur-md text-textSecondary hover:text-textPrimary font-base py-3 px-6 rounded-xl transition-all duration-300">
                    Oui, démarrer
                </button>
                <button id="cancelStartRideBtn" class="backdrop-blur-sm bg-background/40 border border-background/30 text-textPrimary font-base py-3 px-6 rounded-xl hover:bg-background/60 transition-all duration-300">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation pour terminer un trajet -->
<div id="completeRideModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex items-center justify-center">
    <div class="backdrop-blur-xl backdrop-saturate-150 backdrop-contrast-125 bg-white/30 rounded-2xl shadow-2xl border border-white/30 p-8 max-w-md mx-4 transform transition-all">
        <div class="text-center">
            <h3 class="text-subtitle font-title text-backgroundDark mb-2">Terminer le trajet</h3>
            <p class="text-background mb-6" id="completeRideText">
                Êtes-vous sûr d'avoir terminé ce trajet ?
            </p>
            <div class="flex gap-4 justify-end">
                <button id="confirmCompleteRideBtn" class="bg-accent hover:bg-accentDark backdrop-blur-sm hover:backdrop-blur-md text-textSecondary hover:text-textPrimary font-base py-3 px-6 rounded-xl transition-all duration-300">
                    Oui, terminer
                </button>
                <button id="cancelCompleteRideBtn" class="backdrop-blur-sm bg-background/40 border border-background/30 text-textPrimary font-base py-3 px-6 rounded-xl hover:bg-background/60 transition-all duration-300">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>


{{ importmap('city-autocomplete') }}

<script>
// Script pour les boutons de compteur sur la page d'accueil
document.addEventListener('DOMContentLoaded', function() {
    const decrementButton = document.getElementById('home-decrement-button');
    const incrementButton = document.getElementById('home-increment-button');
    const quantityInput = document.getElementById('home-quantity-input');
    
    if (decrementButton && incrementButton && quantityInput) {
        decrementButton.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
            }
        });
        
        incrementButton.addEventListener('click', function() {
            const currentValue = parseInt(quantityInput.value);
            if (currentValue < 4) {
                quantityInput.value = currentValue + 1;
            }
        });
    }
    
    // Initialiser l'autocomplétion des villes
    if (typeof CityAutocomplete !== 'undefined') {
        new CityAutocomplete('home-departure', 'home-departure-suggestions');
        new CityAutocomplete('home-arrival', 'home-arrival-suggestions');
    }
    
    // Initialiser le carousel des avis
    initReviewsCarousel();
});

let rideToStart = null;
let rideToComplete = null;

// Fonctions pour gérer les trajets
function startRide(rideId) {
    rideToStart = rideId;
    document.getElementById('startRideModal').classList.remove('hidden');
}

function completeRide(rideId) {
    rideToComplete = rideId;
    document.getElementById('completeRideModal').classList.remove('hidden');
}

// Gestionnaires d'événements pour les modals
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('confirmStartRideBtn').addEventListener('click', function() {
        if (rideToStart) {
            fetch(`/ride/${rideToStart}/start`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur lors du démarrage du trajet');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors du démarrage du trajet');
            });
        }
        document.getElementById('startRideModal').classList.add('hidden');
        rideToStart = null;
    });

    document.getElementById('cancelStartRideBtn').addEventListener('click', function() {
        document.getElementById('startRideModal').classList.add('hidden');
        rideToStart = null;
    });

    document.getElementById('confirmCompleteRideBtn').addEventListener('click', function() {
        if (rideToComplete) {
            fetch(`/ride/${rideToComplete}/complete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Erreur lors de la terminaison du trajet');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de la terminaison du trajet');
            });
        }
        document.getElementById('completeRideModal').classList.add('hidden');
        rideToComplete = null;
    });

    document.getElementById('cancelCompleteRideBtn').addEventListener('click', function() {
        document.getElementById('completeRideModal').classList.add('hidden');
        rideToComplete = null;
    });

    // Fermer les modals en cliquant en dehors
    document.getElementById('startRideModal').addEventListener('click', function(event) {
        if (event.target === this) {
            this.classList.add('hidden');
            rideToStart = null;
        }
    });

    document.getElementById('completeRideModal').addEventListener('click', function(event) {
        if (event.target === this) {
            this.classList.add('hidden');
            rideToComplete = null;
        }
    });
});

// Fonction pour gérer le carousel des avis
function initReviewsCarousel() {
    const carousel = document.getElementById('reviewsCarousel');
    const indicators = document.querySelectorAll('.review-indicator');
    const slides = document.querySelectorAll('.review-slide');
    
    if (!carousel || slides.length === 0) return;
    
    let currentIndex = 0;
    let interval;
    
    // Fonction pour afficher un avis spécifique
    function showSlide(index) {
        if (index < 0) index = slides.length - 1;
        if (index >= slides.length) index = 0;
        
        currentIndex = index;
        const translateX = -index * 100;
        carousel.style.transform = `translateX(${translateX}%)`;
        
        // Mettre à jour les indicateurs
        indicators.forEach((indicator, i) => {
            if (i === index) {
                indicator.classList.add('bg-accent');
                indicator.classList.remove('bg-accent/50');
            } else {
                indicator.classList.remove('bg-accent');
                indicator.classList.add('bg-accent/50');
            }
        });
    }
    
    // Fonction pour passer à l'avis suivant
    function nextSlide() {
        showSlide(currentIndex + 1);
    }
    
    // Démarrer la rotation automatique
    function startAutoRotation() {
        interval = setInterval(nextSlide, 10000); // 10 secondes
    }
    
    // Arrêter la rotation automatique
    function stopAutoRotation() {
        if (interval) {
            clearInterval(interval);
        }
    }
    
    // Gestionnaires d'événements pour les indicateurs
    indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => {
            stopAutoRotation();
            showSlide(index);
            startAutoRotation(); // Redémarrer après interaction manuelle
        });
    });
    
    // Pause au survol
    carousel.addEventListener('mouseenter', stopAutoRotation);
    carousel.addEventListener('mouseleave', startAutoRotation);
    
    // Démarrer la rotation automatique
    startAutoRotation();
}
</script>

{% endblock %}

